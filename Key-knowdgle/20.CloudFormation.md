# AWS CloudFormation Summary (Continued)

## **Template Structure & Components**

**Template Building Blocks**
- **AWSTemplateFormatVersion**: "2010-09-09" (identifies template capabilities)
- **Description**: Comments about the template
- **Resources (MANDATORY)**: AWS resources declared in template
- **Parameters**: Dynamic inputs for template
- **Mappings**: Static variables for template
- **Outputs**: References to what has been created
- **Conditionals**: List of conditions for resource creation

**Template Helpers**
- **References**: Link to parameters and resources
- **Functions**: Built-in functions for template logic

## **Parameters**

**Parameter Types**
- **String, Number**: Basic data types
- **CommaDelimitedList, List<Number>**: Array types
- **AWS-Specific Parameter**: Match against existing AWS account values
- **SSM Parameter**: Get values from SSM Parameter Store

**Parameter Settings**
- **Description, ConstraintDescription**: Documentation
- **Min/MaxLength, Min/MaxValue**: Validation constraints
- **Default**: Default value if not provided
- **AllowedValues**: Array of permitted values
- **AllowedPattern**: Regex validation
- **NoEcho**: Hide sensitive values (like passwords)

**When to Use Parameters**
- Template reuse across company/environments
- Values that cannot be determined ahead of time
- Configurations likely to change in the future

## **Mappings**

**Purpose & Usage**
- Fixed variables within CloudFormation template
- Differentiate between environments, regions, AMI types
- All values hardcoded within template
- Great when values can be deduced from variables (Region, AZ, Environment)

**Accessing Mappings**
- Use `Fn::FindInMap` function
- Syntax: `!FindInMap [MapName, TopLevelKey, SecondLevelKey]`
- Common use case: Region-specific AMI IDs

**Mappings vs Parameters**
- **Use Mappings**: When values are known in advance and deducible
- **Use Parameters**: When values are user-specific or unknown at template creation

## **Outputs**

**Core Functionality**
- Declare optional output values for cross-stack references
- Export values to import in other stacks
- View outputs in AWS Console or CLI
- Best practice for cross-stack collaboration

**Cross-Stack References**
- Export outputs using `Export` property
- Import using `Fn::ImportValue` function
- Cannot delete stack until all references are removed
- Enables modular template architecture

## **Conditions**

**Purpose**
- Control resource creation based on conditions
- Common conditions: Environment (dev/test/prod), AWS Region, parameter values
- Each condition can reference other conditions, parameters, or mappings

**Condition Functions**
- **Fn::And**: Logical AND operation
- **Fn::Equals**: Equality comparison
- **Fn::If**: Conditional logic
- **Fn::Not**: Logical NOT operation
- **Fn::Or**: Logical OR operation

## **Intrinsic Functions**

**Essential Functions**
- **Fn::Ref (!Ref)**: Reference parameters or resources
- **Fn::GetAtt**: Get attributes of resources
- **Fn::FindInMap**: Access mapping values
- **Fn::ImportValue**: Import cross-stack values
- **Fn::Join**: Concatenate values
- **Fn::Sub**: String substitution
- **Fn::Base64**: Convert string to Base64

**Pseudo Parameters**
- **AWS::AccountId**: Current AWS account ID
- **AWS::Region**: Current AWS region
- **AWS::StackId**: CloudFormation stack ID
- **AWS::StackName**: Stack name
- **AWS::NotificationARNs**: SNS notification ARNs

## **Advanced Features**

**Stack Policies**
- JSON document defining allowed update actions
- Protect resources from unintentional updates
- All resources protected by default when policy is set
- Must explicitly allow updates for specific resources

**DeletionPolicy**
- **Delete**: Default behavior, remove resource
- **Retain**: Preserve resource when stack is deleted
- **Snapshot**: Create final snapshot before deletion (EBS, RDS, etc.)

**Termination Protection**
- Prevent accidental deletion of CloudFormation stacks
- Must be disabled before stack can be deleted
- Additional safety measure for critical infrastructure

## **Rollback & Error Handling**

**Stack Creation Failures**
- Default: Everything rolls back (gets deleted)
- Option to disable rollback for troubleshooting
- View logs to understand failure reasons

**Stack Update Failures**
- Automatic rollback to previous known working state
- Log analysis available for error messages
- Manual fix required for rollback failures

**Rollback Recovery**
- Use `ContinueUpdateRollback` API from Console
- CLI command: `continue-update-rollback`
- Fix resources manually before continuing

## **Security & Permissions**

**Service Roles**
- IAM role allowing CloudFormation to manage resources
- Enables least privilege principle for users
- User needs `iam:PassRole` permission
- Separates user permissions from resource creation permissions

**Capabilities**
- **CAPABILITY_IAM/CAPABILITY_NAMED_IAM**: Required for IAM resource creation
- **CAPABILITY_AUTO_EXPAND**: Required for Macros or Nested Stacks
- Security acknowledgment for template changes

## **Custom Resources**

**Use Cases**
- Define resources not yet supported by CloudFormation
- Custom provisioning logic for external resources
- Run custom scripts during create/update/delete operations
- Handle on-premises or third-party resources

**Implementation**
- Use `AWS::CloudFormation::CustomResource`
- Backed by Lambda function (most common) or SNS topic
- Custom logic for resource lifecycle management

## **Best Practices**

**Template Organization**
- Use parameters for values likely to change
- Implement mappings for environment-specific configurations
- Leverage outputs for cross-stack integration
- Apply conditions for environment-specific resources

**Deployment Strategy**
- Use automated deployment with AWS CLI
- Version control templates with Git
- Implement proper testing before production deployment
- Utilize separation of concerns (VPC, Network, App stacks)

**Cost Management**
- Tag resources through CloudFormation for cost tracking
- Estimate costs using CloudFormation templates
- Automate dev environment deletion/creation for cost savings
- Monitor stack costs through tagged resource groups